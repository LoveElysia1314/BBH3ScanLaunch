# BBH3ScanLaunch 日志输出标准

## 核心原则

### 默认静默
- 成功路径不输出（包括 debug），除非对用户体验必要的进度提示
- 正常业务流程默认安静执行，避免日志噪音

### 单一所有者
- 同一事件只在一个层级输出一次，避免上下层重复
- 明确每类日志的归属层，防止重复转述

### 异常优先
- 回退/降级用 Warning
- 不可恢复的失败用 Error
- 仅用户需感知的流程节点使用 Info

### 少且准
- 少量高质量日志优先于频繁细碎日志

## 日志级别定义

### Info
- **用途**: 用户需要看到的关键流程节点，且一阶段仅一次
- **示例**: "开始登录"、"登录成功"、"开始获取OA"、"获取OA成功"、"有更新"、"已是最新版本"
- **频率**: 每个流程阶段最多一次

### Warning
- **用途**: 出现回退、降级、使用兜底或可继续但非预期的情况
- **示例**: "使用硬编码源"、"切换下一个源"、"使用缓存版本号"
- **频率**: 发生异常情况时输出，可适当节流避免刷屏

### Error
- **用途**: 失败并阻断流程或需要用户介入
- **示例**: "无法获取远程版本信息"、"无法更新本地文件"、"获取OA失败"
- **频率**: 每次失败都应输出，包含足够的错误信息供排查

## 日志归属权划分

### 应用层 (main.py)
**职责**: 
- 负责 Info 级别的用户可见流程节点提示（每个阶段一次）
- 对返回错误统一输出 Error，描述"做了什么 + 为什么失败"
- 不重复转述底层错误细节

**保留的 Info 日志**:
- 更新状态: 正在获取远程版本信息...
- 更新状态: 当前已是最新版本
- 登陆B站账号.../登陆成功
- 登陆崩坏3账号中...
- 登陆成功！获取OA服务器信息中...
- 当前崩坏3版本: X.Y.Z
- 获取OA服务器成功！
- 登录流程完成，准备启动解析线程...
- 登录完成，解析线程已启动

### 基础设施层
**包含模块**: `utils/network_utils.py`, `utils/config_utils.py`, `core/sdk/mihoyosdk.py`, `utils/version_utils.py`

**职责**:
- 成功路径默认不输出（不 Info、不 Debug）
- 若能够指示程序进程，则允许酌情保留
- 发生回退/降级输出 Warning
- 不可恢复失败输出 Error
- 不输出"成功从某源获取..."这类成功信息

## 按模块的具体标准

### main.py
- **保留 Info**: 每阶段流程节点（开始登录B站、登录成功、开始登录崩坏3、开始获取OA信息、获取OA成功、更新状态）
- **避免重复**: 不在调用 `check_program_update` 后重复输出来源细节
- **错误处理**: 对错误统一 Error（从返回值的 error 字段判断），不重复描述底层细节

### utils/network_utils.py
- **成功路径**: 获取 version.json/changelog 成功时不输出任何日志
- **Warning**: "本地配置中无 version_url 源，使用硬编码回退逻辑"等回退情况
- **Error**: 请求失败、解析失败、写入失败，错误信息包含目标 URL/文件路径与异常摘要

### utils/config_utils.py
- **check_program_update**: 成功路径默认不输出，根据返回值由调用者决定是否输出 Info
- **Error**: 内部错误（无法获取远程版本/更新失败）输出 Error 并通过返回值携带 error 字段

### core/sdk/mihoyosdk.py
- **getBHVer**: 正常获取成功不输出；使用缓存/回退时 Warning；获取失败 Error
- **getOAServer**: 成功路径不输出"获取 dispatch 成功"；无 token、请求失败、解析失败为 Error

### utils/version_utils.py
- **成功路径**: 读本地配置/日志成功不输出
- **异常处理**: 读写异常由 `handle_exceptions` 注入为 Error（或按当前实现返回默认值并记录错误）

## 去重规则

1. **单一输出**: 同类事件只在"拥有者层"输出一次，调用方不重复转述
2. **错误补充**: 底层遇到 Warning/Error 时，调用方可以补充一条"结果态"的 Info/Warn（非必要），但不重复打印技术细节
3. **时间节流**: 相同的 Warning 不在短时间内重复打印

## 移除的重复日志

以下类型的日志应该移除：
- `成功从 gitee 获取远程版本信息 (configured)` 及重复的同类成功日志
- `成功从 gitee 获取changelog`（成功路径细节）
- 其他底层成功细节（除非回退/失败）

## 文案规范

### 统一模板
- 动宾结构，前缀含动作，后缀含对象
- 示例: "获取OA服务器成功！"、"无法获取远程版本信息：{原因}"

### 敏感数据处理
- 避免打印敏感数据（账号、token、cookie、签名）
- 账号信息仅显示脱敏 uname（中间星号）
- ID 部分使用掩码处理

## 验收标准

### 成功场景的期望日志输出
```
[INFO] 系统初始化完成，等待操作...
[INFO] 配置文件已有账号，尝试登陆中...
[INFO] 更新状态: 正在获取远程版本信息...
[INFO] 正在登录B站账号...
[INFO] 验证缓存账号 LoveElysia1314 中...
[INFO] 更新状态: 当前已是最新版本
[INFO] 登陆B站账号 LoveElysia1314 成功！
[INFO] 登陆崩坏3账号中...
[INFO] 登录成功，账号：LoveElysia1314
[INFO] 登陆成功！获取OA服务器信息中...
[INFO] 当前崩坏3版本: 8.5.0
[INFO] 获取OA服务器成功！
[INFO] 登录流程完成，准备启动解析线程...
[INFO] 登录完成，解析线程已启动
```

### 不应出现的重复日志
- 同一获取动作的多次成功提示
- 底层实现细节的成功路径日志
- 技术细节的重复转述

## 实施建议

1. **标准采纳**: 先在团队层面采纳此标准
2. **归属梳理**: 做一次"日志所有权梳理"清单，列出每条 Info/Warn/Error 的唯一归属点
3. **分批调整**: 先基础层（去掉成功路径日志），再应用层（确保 Info 只出现一次）
4. **验收测试**: 对照期望日志输出进行验收

---
*此标准旨在减少日志噪音，提高日志质量，确保关键信息不被淹没在冗余输出中。*